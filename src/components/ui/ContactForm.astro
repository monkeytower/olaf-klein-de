---

---

<div id="form-container">
  <form
    id="contact-form"
    class="space-y-2 flex flex-col h-full"
    autocomplete="on"
  >
    {/* Security: Invisible Honeypot */}
    <div
      class="opacity-0 absolute top-0 left-0 h-0 w-0 -z-50 pointer-events-none"
      aria-hidden="true"
    >
      <label for="bot-field">Don't fill this out if you're human:</label>
      <input
        type="text"
        name="bot-field"
        id="bot-field"
        tabindex="-1"
        autocomplete="off"
      />
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div class="space-y-1">
        <label
          for="name"
          class="text-xs font-semibold opacity-60 ml-1"
          data-t="full-name"
        >
          Name
        </label>
        <input
          type="text"
          name="name"
          id="name"
          required
          class="w-full bg-slate-50 dark:bg-white/5 border-2 border-[var(--border-color)] px-4 py-2 text-black dark:text-white rounded-xl focus:border-primary focus:bg-[var(--bg-color)] focus:outline-none transition-all duration-200 placeholder:text-slate-600 dark:placeholder:text-slate-400/50"
          placeholder="e.g. John Doe"
          data-t="full-name"
          autocomplete="name"
        />
      </div>

      <div class="space-y-1">
        <label
          for="email"
          class="text-xs font-semibold opacity-60 ml-1"
          data-t="email-address"
        >
          Email Address
        </label>
        <input
          type="email"
          name="email"
          id="email"
          required
          class="w-full bg-slate-50 dark:bg-white/5 border-2 border-[var(--border-color)] px-4 py-2 text-black dark:text-white rounded-xl focus:border-primary focus:bg-[var(--bg-color)] focus:outline-none transition-all duration-200 placeholder:text-slate-600 dark:placeholder:text-slate-400/50"
          placeholder="john@example.com"
          data-t="email-address"
          autocomplete="email"
        />
      </div>
    </div>

    <div class="space-y-1 flex-grow flex flex-col relative">
      <label
        for="message"
        class="text-xs font-semibold opacity-60 ml-1"
        data-t="message-label"
      >
        Message
      </label>
      <textarea
        name="message"
        id="message"
        rows="8"
        required
        class="w-full flex-grow bg-slate-50 dark:bg-white/5 border-2 border-[var(--border-color)] px-4 py-2 text-black dark:text-white rounded-xl focus:border-primary focus:bg-[var(--bg-color)] focus:outline-none transition-all duration-200 resize-none placeholder:text-slate-600 dark:placeholder:text-slate-400/50"
        placeholder="wobei kann ich helfen?"
        data-t="help-placeholder"></textarea>

      {/* Dictation Button */}
      <button
        type="button"
        id="dictation-btn"
        class="hidden absolute top-8 right-3 p-2 text-slate-400 hover:text-primary transition-all active:scale-95"
        aria-label="Start Dictation"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-mic"
        >
          <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" x2="12" y1="19" y2="22"></line>
        </svg>
      </button>
    </div>

    {/* Security: Cloudflare Turnstile */}
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer></script>
    <div class="flex justify-center py-2">
      <div
        class="cf-turnstile"
        data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}
        data-theme="auto"
      >
      </div>
    </div>

    <script is:inline>
      (function () {
        const setTheme = () => {
          const turnstileWidget = document.querySelector(".cf-turnstile");
          if (turnstileWidget) {
            const isDark = document.documentElement.classList.contains("dark");
            turnstileWidget.setAttribute(
              "data-theme",
              isDark ? "dark" : "light"
            );
          }
        };

        // Set on load
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setTheme);
        } else {
          setTheme();
        }

        // Listen for user theme toggles
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === "class") {
              setTheme();
            }
          });
        });
        observer.observe(document.documentElement, { attributes: true });
      })();
    </script>

    <button
      id="submit-button"
      type="submit"
      class="w-full flex items-center justify-center gap-4 px-8 py-4 border-2 border-[var(--text-color)] text-[var(--text-color)] rounded-xl font-bold text-sm lg:text-sm tracking-wide transition-all hover:bg-[var(--text-color)]/5 active:scale-95 mt-4 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
    >
      <span id="button-text" data-t="send-message">Send Message</span>
    </button>
  </form>

  {/* Success State */}
  <div id="success-state" class="hidden space-y-6 py-4 animate-reveal-in">
    <div class="flex flex-col items-center text-center space-y-4">
      <div
        class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center text-green-600 dark:text-green-400"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-check"><path d="M20 6 9 17l-5-5"></path></svg
        >
      </div>
      <div class="space-y-2">
        <h2 class="text-2xl font-bold" data-t="success-title">Message Sent!</h2>
        <p class="text-slate-500 dark:text-slate-400" data-t="success-body">
          Thank you for getting in touch. I'll get back to you shortly.
        </p>
      </div>
    </div>

    <div
      class="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 space-y-3 border border-[var(--border-color)] text-xs font-mono opacity-80 overflow-auto"
    >
      <p class="flex justify-between">
        <span class="font-bold opacity-60">Message ID:</span>
        <span id="success-id" class="break-all ml-4"></span>
      </p>
      <p class="flex justify-between">
        <span class="font-bold opacity-60">Timestamp:</span>
        <span id="success-time"></span>
      </p>
    </div>

    <button
      id="reset-success"
      type="button"
      class="w-full py-3 border-2 border-[var(--text-color)] text-[var(--text-color)] font-bold rounded-xl hover:bg-[var(--text-color)]/5 transition-all active:scale-95"
      data-t="reset-button"
    >
      one more thing...
    </button>
  </div>

  {/* Error State */}
  <div id="error-state" class="hidden space-y-6 py-4 animate-reveal-in">
    <div class="flex flex-col items-center text-center space-y-4">
      <div
        class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center text-red-600 dark:text-red-400"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-x-circle"
          ><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"
          ></path><path d="m9 9 6 6"></path></svg
        >
      </div>
      <div class="space-y-2">
        <h2 class="text-2xl font-bold" data-t="error-title">
          Submission Failed
        </h2>
        <p id="error-message" class="text-red-500/80"></p>
      </div>
    </div>

    <div
      id="error-details"
      class="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 text-xs font-mono opacity-80 border border-red-200/20"
    >
      <p class="flex justify-between">
        <span class="font-bold opacity-60">Timestamp:</span>
        <span id="error-time"></span>
      </p>
    </div>

    <button
      id="reset-error"
      type="button"
      class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:brightness-110 transition-all active:scale-95"
      data-t="try-again"
    >
      Try Again
    </button>
  </div>
</div>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const submitButton = document.getElementById(
    "submit-button"
  ) as HTMLButtonElement;
  const buttonText = document.getElementById("button-text");

  const successState = document.getElementById("success-state");
  const errorState = document.getElementById("error-state");

  const resetSuccess = document.getElementById("reset-success");
  const resetError = document.getElementById("reset-error");

  const showForm = () => {
    form?.classList.remove("hidden");
    successState?.classList.add("hidden");
    errorState?.classList.add("hidden");
    form?.reset();

    // @ts-ignore - Trigger Turnstile reset if available
    if (window.turnstile) {
      // @ts-ignore
      window.turnstile.reset();
    }
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    console.log("Form submission started...");

    // UI State
    if (submitButton) submitButton.disabled = true;

    const currentLang =
      localStorage.getItem("lang") ||
      (navigator.language.startsWith("de") ? "de" : "en");
    const translations = {
      en: { "send-message": "Send Message", sending: "Sending..." },
      de: { "send-message": "Nachricht senden", sending: "Sende..." },
    };

    if (buttonText) {
      // @ts-ignore
      buttonText.innerText = translations[currentLang]["sending"];
    }

    try {
      const formData = new FormData(form);
      const response = await fetch("/api/send-mail", {
        method: "POST",
        body: formData,
      });

      console.log("API Response received:", response.status);

      const result = await response.json();
      console.log("Result data:", result);

      if (response.ok && result.success) {
        // Success Logic
        console.log("Success triggered");
        form?.classList.add("hidden");
        successState?.classList.remove("hidden");

        const idEl = document.getElementById("success-id");
        const timeEl = document.getElementById("success-time");

        if (idEl) idEl.innerText = result.id || "N/A";
        if (timeEl)
          timeEl.innerText = new Date(result.timestamp).toLocaleString();
      } else {
        throw new Error(result.message || "Unknown error occurred");
      }
    } catch (err: any) {
      console.error("Submission catch triggered:", err);
      // Error Logic
      form?.classList.add("hidden");
      errorState?.classList.remove("hidden");

      const msgEl = document.getElementById("error-message");
      const timeEl = document.getElementById("error-time");

      if (msgEl) msgEl.innerText = err.message;
      if (timeEl) timeEl.innerText = new Date().toLocaleString();
    } finally {
      console.log("Submission finally triggered");
      if (submitButton) submitButton.disabled = false;

      if (buttonText) {
        const key = buttonText.getAttribute("data-t");
        // @ts-ignore
        buttonText.innerText = translations[currentLang][key] || "Send Message";
      }
    }
  });

  resetSuccess?.addEventListener("click", showForm);
  resetError?.addEventListener("click", showForm);

  // --- Dictation Logic (Web Speech API) ---
  const dictationBtn = document.getElementById("dictation-btn");
  const messageInput = document.getElementById("message");

  // Check support
  if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
    // Show button if supported
    dictationBtn?.classList.remove("hidden");

    // @ts-ignore
    const SpeechRecognition =
      // @ts-ignore
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.continuous = false;
    recognition.interimResults = false;

    // Detect Language
    const getLang = () => {
      const stored = localStorage.getItem("lang");
      if (stored) return stored === "de" ? "de-DE" : "en-US";
      return navigator.language.startsWith("de") ? "de-DE" : "en-US";
    };

    const resetButton = () => {
      dictationBtn?.classList.remove(
        "text-red-500",
        "animate-pulse",
        "text-yellow-500"
      );
      dictationBtn?.classList.add("text-slate-400");
    };

    recognition.onstart = () => {
      dictationBtn?.classList.add("text-red-500", "animate-pulse");
      dictationBtn?.classList.remove("text-slate-400", "text-yellow-500");
    };

    recognition.onend = () => {
      resetButton();
    };

    recognition.onerror = (event) => {
      console.error("Speech recognition error", event.error);
      resetButton();

      // Visual feedback for error
      if (dictationBtn) {
        dictationBtn.classList.add("text-yellow-500"); // Standard warning color
        setTimeout(() => {
          dictationBtn.classList.remove("text-yellow-500");
        }, 1000);
      }
    };

    // @ts-ignore
    recognition.onresult = (event) => {
      let finalTranscript = "";
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript;
        } else {
          finalTranscript += event.results[i][0].transcript;
        }
      }

      if (messageInput && finalTranscript) {
        // @ts-ignore
        const currentVal = messageInput.value;
        // @ts-ignore
        // Add a space if there is already text
        messageInput.value = currentVal.trim()
          ? currentVal.trim() + " " + finalTranscript
          : finalTranscript;

        // Trigger generic input event for any listeners
        messageInput.dispatchEvent(new Event("input", { bubbles: true }));
      }
    };

    dictationBtn?.addEventListener("click", () => {
      if (dictationBtn.classList.contains("text-red-500")) {
        recognition.stop();
      } else {
        recognition.lang = getLang();
        try {
          messageInput?.focus(); // Explicitly focus for Desktop support
          recognition.start();
        } catch (e) {
          console.error("Recognition start error", e);
        }
      }
    });
  }
</script>
