---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { createReader } from "@keystatic/core/reader";
import config from "../../keystatic.config";

// Initialize Keystatic Reader
const reader = createReader(process.cwd(), config);

export async function getStaticPaths() {
  const pages = await getCollection("pages");
  return pages.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

let { entry } = Astro.props;
const { slug } = Astro.params;

if (!entry && slug) {
  const fetchedEntry = await getEntry("pages", slug);
  if (fetchedEntry) {
    entry = fetchedEntry;
  }
}

if (!entry) {
  return Astro.redirect("/404");
}

const { Content } = await entry.render();

// Breadcrumb Logic
const isDocsPage = entry.slug.includes("/docs/");
const isEn = entry.slug.includes("/en/");
const isDe = entry.slug.includes("/de/");
const lang = isDe ? "de" : "en";

// Fetch settings for footer/social
const settings = await reader.singletons.settings.read();

// Breadcrumb Logic Labels
const labels = {
  en: { home: "Home", docs: "Documentation" },
  de: { home: "Startseite", docs: "Dokumentation" },
};
const t = isDe ? labels.de : labels.en;
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.seoDescription}
  socialLinks={settings?.socialLinks || []}
>
  <script is:inline>
    // Handle redirection for legacy or non-lang-prefixed docs links
    if (window.location.pathname === "/docs/intro") {
      const savedLang =
        localStorage.getItem("lang") ||
        (navigator.language.startsWith("de") ? "de" : "en");
      window.location.href = `/docs/${savedLang}/intro`;
    }
  </script>

  <div class="max-w-4xl mx-auto px-4 sm:px-12 lg:px-20 py-12">
    {/* Breadcrumb Navigation */}
    <nav
      class="mb-12 flex items-center gap-2 text-sm font-bold opacity-60 hover:opacity-100 transition-opacity"
    >
      <a href="/" class="hover:text-primary transition-colors">{t.home}</a>

      {
        isDocsPage && !entry.slug.endsWith("/intro") && (
          <>
            <span class="opacity-40">/</span>
            <a
              href={`/docs/${lang}/intro`}
              class="hover:text-primary transition-colors"
            >
              {t.docs}
            </a>
          </>
        )
      }

      <span class="opacity-40">/</span>
      <span class="text-primary opacity-100 capitalize">
        {
          entry.slug
            .split("/")
            .pop()
            ?.replace(/-/g, " ")
            .replace(/step(\d+)/, "Step $1")
        }
      </span>
    </nav>

    {
      /* Header - Only show for non-docs pages or the Intro to avoid duplication in sub-steps */
    }
    {
      (!isDocsPage || entry.slug.endsWith("/intro")) && (
        <header class="mb-12">
          <h1 class="font-heading text-4xl font-bold md:text-5xl text-primary mb-4">
            {entry.data.title}
          </h1>
          {entry.data.seoDescription && (
            <p class="text-lg md:text-xl opacity-80 leading-relaxed font-light">
              {entry.data.seoDescription}
            </p>
          )}
        </header>
      )
    }

    {/* Content */}
    <article
      class="prose prose-lg prose-slate dark:prose-invert prose-headings:font-heading prose-headings:font-bold prose-a:text-primary prose-a:no-underline hover:prose-a:underline max-w-none"
    >
      <Content />
    </article>

    {/* Page Footer / Next Steps */}
    <hr class="my-12 border-[var(--border-color)]" />

    <div class="flex justify-between items-center opacity-60 text-sm">
      <span>&copy; Olaf Klein</span>
      <a href="#top" class="hover:text-primary transition-colors"
        >Back to Top &uarr;</a
      >
    </div>
  </div>
</BaseLayout>
